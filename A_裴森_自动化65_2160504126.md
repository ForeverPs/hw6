## <center> 数字图像处理作业六 </center>
#### <center> *裴森 &ensp;自动化&ensp;65 &ensp;2160504126* </center>
***
&emsp;本次数字图像处理的作业主要是对图像添加噪声并进行滤波恢复，在实验中用到的噪声以及滤波方法主要有以下几种：
* 高斯噪声与椒盐噪声
* 算术均值滤波器与几何均值滤波器
* 逆谐波均值滤波器
* 运动模糊
* 维纳滤波器
* 约束最小二乘方滤波<br>

&emsp;另外，在本次实验中用到的噪声与均值滤波器均是在时空域实现的，而运动模糊，维纳滤波以及最小二乘方滤波则需要在频域实现。
***
### 一.高斯噪声与椒盐噪声
#### 高斯噪声
&emsp;噪声其实就是一组满足一定分布率的灰度值，要想产生噪声，实际上就是产生对应分布的一个采样集。<br>
&emsp;例如，要得到高斯噪声，那就只需要产生一组均值为`mean`，标准差为`sigma`的一组随机数即可，然后将这组随机数加入到原始图像中，为了灰度图的正常显示，在必要的情况下需要对超出`0-255`范围的灰度值进行处理。另外，在得到最终处理结果后，应当将像素值化为整数。<br>
&emsp;高斯噪声的分布满足以下概率密度公式：<br><br>
&ensp;&ensp;<img src= eq1.gif /> <br><br>
&emsp;其中，上式中的`z`代表灰度值，`p(z)`代表灰度值出现的概率密度。在产生高斯噪声的时候需要指定两个参数的数值，分别是灰度值的均值<img src= eq2.gif />与灰度值分布的标准差<img src= C:\Users\peisen\Desktop\数字图像处理\第6次作业\eq3.gif />。在一般情况下，均值都选择为`0`。标准差越大，高斯噪声的灰度值离散情况越严重，分布越不均匀，对图像的影响也就越大。例如对`lena.bmp`都采用均值为`0`的高斯噪声，但是指定不同的标准差<img src= eq3.gif />，可以得到以下一系列对比图像：<br>
&emsp;&emsp;<img src= n_gau.png width=650 height=340 /><br> 
**<center>图片1.高斯噪声</center>**<br>
&emsp;从图片1可以看出，在均值相同的情况下，<img src= eq3.gif />越大，高斯噪声越明显。当<img src= eq3.gif />=0并且均值也为0时，就是原图，也就是图片1中的第一幅图像。<br>
#### 椒盐噪声
&emsp;椒盐噪声是一种形象的说法，胡椒一般为黑色，因此椒噪声代表灰度值为0的噪声，视觉上表现为一个黑点；盐一般为白色，因此盐噪声代表灰度值为255的噪声，视觉上表现为一个白点。在产生椒盐噪声时，需要指定椒噪声与盐噪声的概率，它们的分布满足以下概率密度公式：<br><br>
&ensp;&ensp;<img src= eq4.gif /> <br><br>
&emsp;上式中，`a`代表椒噪声，即黑色点；`b`代表盐噪声，即白色点。<img src= eq5.gif /> 分别代表椒噪声与盐噪声出现的概率，这两个参数需要指定。另外注意一点，椒盐噪声并不是通常的加性噪声，也就是说，它不能像高斯噪声那样产生一系列灰度值，然后与原图做加法，这显然是不合理的。我所采用的处理方式是：<br>
* 随机生成一系列分布在`0-1`之间的数字，数字的数目与图片像素数相同。
* 以交互方式得到用户指定的<img src= eq5.gif />
* 如果随机数小于<img src= eq6.gif />，则把图像中对应位置的像素值置为`0`，代表椒噪声。
* 如果随机数大于<img src= eq7.gif />，则把图像中对应位置的像素值置为`255`，代表盐噪声。
* 其他位置的像素值不做改动。<br>

&emsp;上面所说的处理方式保证了椒噪声与盐噪声是按照指定的概率分布的，以`lena.bmp`图像为例，分别对她添加盐噪声，椒噪声以及椒盐噪声，得到图片2中的结果：<br>
&emsp;&emsp;<img src= n_ps.png width=650 height=220 /><br> 
**<center>图片2.椒盐噪声</center>**<br>
***
### 二.噪声的消除
#### 高斯噪声：
&emsp;通常来说，一幅图片中的噪声仅仅占据图片的少部分像素，这表明仍可以根据未被噪声污染的图像来近似恢复原始图像。<br>
&emsp;一个看起来必定成立的事实是：在噪声点像素周围，非噪声点占据的比重要远远大于噪声点占据的比重。这在暗示我们，通过均值滤波的方法恢复图像是可行的。<br>
&emsp;对于高斯噪声来说，算术均值滤波器(Arithmetic mean filter)与几何均值滤波器(Geometric mean filter)都是比较有效果的，相对于算术均值滤波器来说，几何均值滤波器往往能保留更多的图像细节。另外，中值滤波器对于高斯噪声的处理效果也是可以的。这些滤波器的时空域实现方式如下：<br>
* 算术均值滤波器-----Arithmetic mean filter<br><br>
&emsp;<img src= eq8.gif /><br>
* 几何均值滤波器-----Geometric mean filter<br><br>
&emsp;<img src= eq9.gif /><br>
* 中值滤波器-----Median filter<br><br>
&emsp;<img src= eq10.gif /><br>

&emsp;上述三个滤波器中，<img src= eq11.gif /> 均代表根据噪声图像恢复后的原始图像的一个近似，可以看出，算术均值滤波器就是在给定的窗口大小范围内计算像素的平均值；几何均值滤波器是在滤波窗口内计算所有像素的几何均值；中值滤波器是一种常用的排序滤波器，它可以得到滤波范围内像素的中位数。<br>
&emsp;以高斯噪声为例，选取均值<img src= eq2.gif />=0，标准差<img src= eq3.gif />=20的高斯噪声加入到原始图像`lena.bmp`中，分别用上述三种滤波器进行滤波，设置的窗口大小均为`3x3`，得到结果如图片3所示：<br><br>
&emsp;&emsp;<img src= m_f.png width=500 height=400 /><br> 
**<center>图片3.对高斯噪声滤波</center>**<br>
&emsp;上面的四幅图片中，第一幅代表的是加入高斯噪声后的图像，后面三幅分别是使用算术均值滤波器，几何均值滤波器以及中值滤波器恢复的结果。从图片中可以看出，算术均值滤波器滤波的结果颜色上要比几何均值滤波的结果更暗，这说明算术均值滤波的灰度值更小，这是因为：<br>
* **几何均值大于等于算术均值**<br>

&emsp;中值滤波器看起来似乎比几何均值更亮一些，但是我们并不能确定一组数值的中位数与其几何均值和算数均值之间的关系：<br>
* **中位数与均值之间的关系是不确定的**<br><br>

#### 椒盐噪声：
&emsp;根据前面部分中对椒盐噪声的介绍，我们可以看出，相对于高斯噪声，椒盐噪声的分布是更加分散的，或者说有极大的方差。并且，前面也说过：<br>
* 噪声点的数量是远远少于非噪声点的<br>

&emsp;这意味着，对于椒盐噪声，我们仍然可以使用上述三种均值滤波器，并且，由于椒噪声与盐噪声的灰度值分布在比较极端的位置，所以，**中值滤波器可以十分完美的工作**。另外，由于椒噪声对应点的灰度值为`0`，这在求几何均值时会使得元素乘积为`0`，导致出现黑斑，为了克服这种情况，我采用了以下改进方法：<br>
* 对于一幅没有先验条件的被椒盐噪声污染的图像，读取后通过观察灰度值，进而确定椒盐噪声点的灰度值并不是一件难事<br>
* 只计算滤波器范围内非椒盐噪声点的几何均值<br>

&emsp;结果证明，经过以上改进的几何均值滤波与中值滤波效果是惊人的，当然，也完全可以在计算算术均值的时候去掉椒盐噪点，那样效果会更好。不过，上述改进总归是建立在能够估计椒盐噪声灰度值的基础上的。<br>
&emsp;用上面三种滤波器对椒盐噪声进行滤波，得到结果如图片4：<br><br>
&emsp;&emsp;<img src= m_p.png width=530 height=400 /><br> 
**<center>图片4.对椒盐噪声滤波</center>**<br>
&emsp;图片4中，椒盐噪声的概率均为`0.05`，几何均值滤波器是改进后的，算术均值滤波器是原始的，效果较差。中值滤波器工作效果也十分不错。<br>
&emsp;除了上面三种常用的均值滤波器外，还有一种滤波器叫做逆谐波均值滤波器(Contraharmonic mean filter)，这种滤波器对于去除椒盐噪声的效果也是十分不错的，它的构造如下：<br><br>
<img src= eq12.gif /><br><br>
&emsp;上式中的`Q`代表滤波器的阶数，它非常擅长去除椒盐噪声，但是，它不能同时去除两种噪声：<br>
* `Q>0`：适合去除椒噪声<br>
* `Q<0`：适合去除盐噪声<br>

&emsp;这意味着我们在去除椒盐噪声时，必须先去除一种噪声，然后再去除另一种。它之所以满足上述规律，我们可以从下面的方向去理解：<br><br>
<img src= eq13.gif /><br><br>
&emsp;很明显，上述转换是成立的，这只是将分母上的和式作为分子中的一个系数。我们只需要关注系数项，也就是：<br><br>
<img src= eq14.gif /><br><br>
* 当`Q>0`时，由于椒噪声处的灰度值非常小，也就是上式中的分母非常小，这将使得椒噪声的权重非常小，起到减小椒噪声的作用。<br>
* 当`Q<0`时，有取倒数的效果，这将会使得灰度值非常大的点得到一个很小的权重，从而起到减小盐噪声的作用。<br>

&emsp;在`lena.bmp`上分别添加椒噪声与盐噪声，概率均为`0.05`，然后分别用`Q=1.5`，`Q=-1.5`对图像进行滤波，得到效果如图片5所示：<br><br>
&emsp;&emsp;<img src= ps.png width=510 height=400 /><br> 
**<center>图片5.逆谐波均值滤波</center>**<br>
&emsp;如果一幅图片中同时含有椒噪声与盐噪声，经过几次测试，我发现先去除盐噪声然后再去除椒噪声效果会比较好，即先令`Q<0`，然后再用`Q>0`处理去除椒噪声后的图像，效果看起来是这样的：<br>
&emsp;&emsp;<img src= chf.png width=680 height=220 /><br> 
**<center>图片6.逆谐波均值滤波</center>**<br>
&emsp;**在这里有一点比较疑惑，就是用`Q<0`去除盐噪声的时候，椒噪声也几乎完全被去除。这可能与椒盐噪声的灰度值有关。**
***
### 三.运动模糊，维纳滤波器以及约束最小二乘方滤波器
#### 运动模糊
&emsp;运动模糊指的是在图片的拍摄过程中，由于图像与传感器之间发生了均匀线性移动而导致的成像模糊。这个过程可以根据运动学公式进行建模，得到的运动模糊公式叫做**退化函数**，建模并求解退化函数的过程就是**建模估计**。在频域中，运动模糊的退化函数可以表示为：<br><br>
<img src= eq15.gif /><br><br>
&emsp;其中，`a,b,T`分别代表沿`x`方向的位移，沿`y`方向的位移以及曝光时间，可以通过调节`a,b`的值来控制移动方向。例如，要想让图像沿`45°`方向移动，则应当使得`a,b`的绝对值相等。<br>
&emsp;为了测试运动模糊的效果，以`lena.bmp`与一张字符图片，选择`a=b=0.01,T=1`，效果如下：<br>
&emsp;&emsp;<img src= sb.png width=600 height=430 /><br> 
**<center>图片7.运动模糊效果</center>**<br>
#### 维纳滤波器
&emsp;维纳滤波器是一种在最小均方误差意义下的最优滤波器，在退化函数与信噪比已知的情况下，维纳滤波器可以很好的恢复模糊图像。在时空域推导维纳滤波器并不是一件容易的事，根据时频的对偶性质，这意味着在频域推导维纳滤波器会十分容易。<br>
&emsp;首先声明几个符号：<br>
* <img src= eq17.gif />&emsp;：原始图像(未退化)的傅里叶变换<br>
* <img src= eq16.gif />&emsp;：经维纳滤波器复原后图像的傅里叶变换<br>
* <img src= eq18.gif />&ensp;：退化函数傅里叶变换<br>
* <img src= eq19.gif />：维纳滤波器的频域表达式<br>
* <img src= eq20.gif />&ensp;：加性噪声的傅里叶变换<br>
* <img src= eq22.gif />&ensp;：被噪声污染后的图像<br>
* <img src= eq21.gif />&emsp;：误差<br>

&emsp;它们之间的关系可以用如下的框图表示：<br>
&emsp;&emsp;<img src= hand.jpg width=600 height=260 /><br> 
**<center>图片8.频域关系框图</center>**<br>
&emsp;根据图片8，可以得到上述变量在频域中的关系(下面设计的乘法均是对应相乘)：<br>
* <img src= eq23.gif /><br>

* <img src= eq24.gif /><br>

* <img src= eq25.gif /><br>

&emsp;维纳滤波器所采用的代价函数是均方误差的期望值，因为仅仅有维纳滤波器`Hw`为变量，因此，代价函数必然是`Hw`的函数，这可以写成以下形式：<br><br>
&emsp;<img src= eq26.gif /><br><br>
&emsp;为了方便推导，由于元素之间是对应相加与相乘，这相当于以为函数，因此用之前定义的变量代表一个标量值，它是傅里叶变换后，矩阵中的某个位置的数值。展开代价函数，并进行化简，可以得到以下过程：<br><br>
&emsp;<img src= eq29.gif /><br>
<img src= eq27.gif /><br>
<img src= eq28.gif /><br>
<img src= eq30.gif /><br><br>
&emsp;用代价函数对维纳滤波器求偏导数，极小值的必要条件是偏导数为0，从而，可以得到维纳滤波器的频域表达式(变量的共轭与变量是不同的，不需要考虑它们之间的函数关系)：<br><br>
<img src= eq31.gif /><br><br>
&emsp;从而解得维纳滤波器的频域表达式为：<br><br>
<img src= eq32.gif /><br><br>
&emsp;其中的`K`代表的是噪声能量与原始图像(未退化)的能量之比，`K`越大说明噪声越强，由于在实际中往往不容易获取`K`值，因此比较常用的方法是不断尝试，选择视觉效果最好的一个`K`值即可。<br>
&emsp;以`lena.bmp`为例，先进行`a=b=0.1,T=1`的运动模糊，然后在添加均值为`0`，方差为`10`的噪声，然后用维纳滤波器进行滤波，得到结果如图片9所示：<br>
&emsp;&emsp;<img src= wiener.png width=600 height=300 /><br> 
**<center>图片9.维纳滤波结果</center>**<br>
&emsp;图片9展示了维纳滤波的效果，选取的`K`值为`0.01`，从结果来看，并没有达到视觉上期待的效果。经过维纳滤波后，也仅仅能看出模糊的轮廓。我重新检查了做变换的模板和傅里叶变换过程，并没有发现存在错误。经过与其他同学讨论，发现他们的效果也比较差，**这个问题我还没有解决**，不过我们推测应该是图像中心`shift`的原因。从课本示例来说，维纳滤波应该能得出比图片9更好的效果。
#### 约束最小二乘方滤波器
&emsp;约束最小二乘方滤波器与维纳滤波器相比，其优点在于仅有一个未知量需要估计，并且该未知量的变化符合单调递增的规律。<br>
&emsp;仍然沿用在维纳滤波器中定义的变量，可以很快得到以下表达式：<br><br>
<img src= eq33.gif /><br><br>
&emsp;从维纳滤波器的表达式可以看出，退化函数在与不同的`K`值配合下所得到的滤波结果差异是非常大的，这说明退化函数`H`对`K`值十分敏感。而最小二乘方的思想就是减小`H`对噪声的敏感性，因此，它定义了如下形式的损失函数：<br><br>
<img src= eq34.gif /><br><br>
&emsp;仍然采用偏导数为`0`的方法，可以得到约束最小二乘方滤波器的频域表达式为：<br><br>
<img src= eq35.gif /><br><br>
&emsp;上式中的`P`代表的是`Laplace`算子的傅里叶变换，这里仅有参数<img src= eq36.gif />是需要估计的变量。并且，由于<img src= eq36.gif />的单调性，使得估计有了方向性。估计的原则如下：<br><br>
<img src= eq37.gif /><br><br>
<img src= eq38.gif /><br><br>
&emsp;可以证明，<img src= q39.gif />是关于<img src= eq36.gif />的单增函数，因此，如果<img src= eq39.gif />没有落到指定的范围内，若偏小，则只需要增大<img src= eq36.gif />，若偏大，则只需要减小<img src= eq36.gif />。<br>
&emsp;用约束最小二乘方对模糊并且添加噪声后的`lena`图像进行滤波，可以得到以下效果：<br>
&emsp;&emsp;<img src= cls.png width=600 height=320 /><br> 
**<center>图片10.约束最小二乘方滤波结果</center>**<br>
&emsp;其中，`CLS`代表的是`Constrained Least Squares`，即约束最小二乘方。从图片10可以看出，约束最小二乘方的恢复效果要好于维纳滤波器，尤其是对于文字的恢复，还是比较清晰的。但是对于`lena.bmp`来说，恢复效果还是略显模糊。<br>
&emsp;另外，上述`laplace`滤波器我选用的是频域形式的定义，即：<br><br>
<img src= eq40.gif /><br><br> 
&emsp;这里由于<img src= eq36.gif />的取值为正数，因此将`laplace`频域形式中的负号去掉了。还有一点，因为频域形式的`laplace`滤波器分量值十分大，远远超过图像的频谱数量级，因此要进行归一化处理，我采用的方法是：<br><br>
<img src= eq41.gif /><br><br> 
&emsp;上面的<img src= eq42.gif />仅仅是为了调节量级，使得<img src= eq36.gif />取值在一个比较合适的范围。









